import torch
import json
from transformers import AutoTokenizer, AutoModelForSequenceClassification
from typing import List, Dict, Any


def load_val_dataset(file_path: str) -> List[Dict[str, Any]]:
    """
    è¯»å–éªŒè¯æ•°æ®é›†
    
    Args:
        file_path: JSONLæ–‡ä»¶è·¯å¾„
        
    Returns:
        åŒ…å«éªŒè¯æ•°æ®çš„åˆ—è¡¨
    """
    data = []
    with open(file_path, 'r', encoding='utf-8') as f:
        for line in f:
            if line.strip():
                data.append(json.loads(line.strip()))
    return data


def load_test_cases() -> List[Dict[str, Any]]:
    """
    åˆ›å»ºæµ‹è¯•ç”¨ä¾‹ï¼ŒåŒ…å«ä¸åŒç±»å‹çš„æ–‡æ¡ˆè´¨é‡å¯¹æ¯”
    """
    test_cases = [
        {
            "name": "ä½¿ç”¨åé¦ˆç±»æ–‡æ¡ˆ - ç§‘å­¦ä¸“ä¸š vs å¤¸å¼ è¥é”€",
            "prompt": "è¯·ä¸º\"åŸç´ æ–¹ç¨‹\"å“ç‰Œçš„å¦‚ä¸‹äº§å“åˆ›ä½œä¸€æ¡ä¾§é‡ä½¿ç”¨åé¦ˆçš„å°çº¢ä¹¦æ–‡æ¡ˆ\n\n{\"product_name\": \"å‡€é¢œç„•é‡‡ç²¾å\", \"category\": \"ç²¾å\", \"core_ingredients\": \"10%çƒŸé…°èƒº, é”ŒPCA, çº¢æ²¡è¯é†‡\", \"features\": \"é«˜æµ“åº¦çƒŸé…°èƒº, æºå¤´æ§æ²¹, æ”¹å–„æš—æ²‰\", \"target_audience\": \"æ²¹æ€§ç—˜ç—˜è‚Œ\"}",
            "chosen": "æ²¹ç—˜è‚Œçš„å¤æ—¥æ•‘æ˜Ÿâœ¨ è¿™æ”¯ç²¾åè®©æˆ‘å‘Šåˆ«'åå…‰è„¸'ï¼\n\næ¯åˆ°å¤å¤©ï¼Œæˆ‘çš„TåŒºå°±åƒä¸ªå°å‹æ²¹ç”°ğŸŒ‹ å¦†å2å°æ—¶å°±å¼€å§‹è„±å¦†ï¼Œæ¯›å­”é‡Œè¿˜èƒ½æŒ¤å‡ºç™½è‰²è§’æ “...ç›´åˆ°é‡åˆ°åŸç´ æ–¹ç¨‹çš„å‡€é¢œç„•é‡‡ç²¾åï¼Œç»ˆäºæ˜ç™½ä»€ä¹ˆå«æºå¤´æ§æ²¹çš„ç§‘å­¦é…æ–¹ã€‚\n\nğŸ§ªæ ¸å¿ƒæˆåˆ†æ‹†è§£ï¼š\nâ€¢ 10%çƒŸé…°èƒºï¼šä¸æ˜¯ç›²ç›®å †æµ“åº¦ï¼è¿™ä¸ªé»„é‡‘é…æ¯”æ—¢èƒ½æŠ‘åˆ¶çš®è„‚è…ºæ´»è·ƒåº¦ï¼Œåˆä¸ä¼šåˆºæ¿€å±éšœï¼ˆå®æµ‹æ¯”æŸäº›15%äº§å“æ›´æ¸©å’Œï¼‰\nâ€¢ é”ŒPCAï¼šåƒå¸æ²¹çº¸ä¸€æ ·å¸é™„è¡¨é¢æ²¹è„‚ï¼Œä½†ä¸ä¼šæ‹”å¹²\nâ€¢ çº¢æ²¡è¯é†‡ï¼šç»™èºåŠ¨çš„ç—˜ç—˜è‚Œ'ç­ç«'ï¼Œæˆ‘ç»æœŸçˆ†ç—˜æ—¶åšæ¶‚å®ƒï¼Œçº¢è‚¿æ¶ˆé€€é€Ÿåº¦è‚‰çœ¼å¯è§\n\nğŸ’¡ä½¿ç”¨Tipsï¼š\næ´é¢åç¬¬ä¸€æ­¥ç”¨ï¼ŒåŠæ»´ç®¡å°±èƒ½ç…§é¡¾å…¨è„¸ã€‚å‡éœ²è´¨åœ°ç§’å¸æ”¶ï¼Œåç»­è·Ÿé˜²æ™’ä¹Ÿä¸ä¼šæ“æ³¥ã€‚ç”¨äº†ä¸‰å‘¨ï¼Œæœ€æƒŠå–œçš„æ˜¯ä¸‹åˆè„¸é¢Šä¸å†æš—æ²‰å¾—åƒéš”å¤œèœï¼Œé¼»ç¿¼çš„æ¯›å­”å±…ç„¶æœ‰'éšå½¢'è¶‹åŠ¿ï¼\n\næ²¹çš®å§å¦¹æ³¨æ„âš ï¸ å¦‚æœæ­£åœ¨ç”¨Aé†‡ç±»äº§å“ï¼Œå»ºè®®é”™å¼€æ—©æ™šä½¿ç”¨ï¼Œé¿å…å åŠ åˆºæ¿€ï½\n\n#ç§‘å­¦æŠ¤è‚¤ #æ²¹çš®ç²¾åå®æµ‹ #å±éšœä¿®æŠ¤ #åŸç´ æ–¹ç¨‹ #æˆåˆ†å…š",
            "rejected": "å§å¦¹ä»¬ï¼æˆ‘å‘ç°äº†æ²¹ç—˜è‚Œçš„æ•‘æ˜Ÿï¼ï¼ï¼åŸç´ æ–¹ç¨‹'å‡€é¢œç„•é‡‡ç²¾å'çœŸçš„ç»ç»å­å•Šï¼ï¼ï¼ğŸ˜±ğŸ˜±ğŸ˜±\n\næ˜¨æ™šç¡å‰æ¶‚äº†å®ƒï¼Œä»Šå¤©é†’æ¥ç›´æ¥æƒŠå‘†ï¼ï¼ï¼è„¸ä¸Šæ²¹ç”°ç›´æ¥å…³é—¸ï¼ï¼ï¼é‚£ä¸ª10%çƒŸé…°èƒºç®€ç›´ç¥äº†ï¼ï¼ï¼ä¸‰å¤©ï¼ï¼ï¼å°±ä¸‰å¤©ï¼ï¼ï¼æˆ‘çš„é™ˆå¹´ç—˜å°å±…ç„¶æ·¡åˆ°å‡ ä¹çœ‹ä¸è§ï¼ï¼ï¼çº¢æ²¡è¯é†‡ç›´æ¥æŠŠæˆ‘æ³›çº¢çš„è„¸è›‹å­å®‰æŠšå¾—åƒå©´å„¿å±è‚¡ä¸€æ ·å«©ï¼ï¼ï¼\n\nä»€ä¹ˆæ§æ²¹å•Šã€æäº®å•Šï¼Œåœ¨å®ƒé¢å‰éƒ½æ˜¯å¼Ÿå¼Ÿï¼ï¼ï¼ç°åœ¨æˆ‘çš„è„¸å°±åƒå¼€äº†ç£¨çš®ç‰¹æ•ˆï¼ï¼ï¼é—ºèœœè¿½ç€æˆ‘é—®æ˜¯ä¸æ˜¯å·å·åšäº†å…‰å­å«©è‚¤ï¼ï¼ï¼\n\næ²¹ç—˜è‚Œçš„å®å­ä»¬å¬æˆ‘çš„ï¼ï¼ï¼å†²å°±å®Œäº‹äº†ï¼ï¼ï¼è¿™ç“¶ç²¾åå°±æ˜¯ä½ ä»¬çš„å‘½è¿è½¬æŠ˜ç‚¹ï¼ï¼ï¼ä¸€å¤œå›æ˜¥ä¸æ˜¯æ¢¦å•Šï¼ï¼ï¼yydsæˆ‘ç›´æ¥é”æ­»ï¼ï¼ï¼ğŸ’¥ğŸ’¥ğŸ’¥"
        },
        {
            "name": "ç§‘æ™®çŸ¥è¯†ç±»æ–‡æ¡ˆ - ä¸“ä¸šç§‘æ™® vs ç®€å•æè¿°",
            "prompt": "è¯·ä¸º\"åŸç´ æ–¹ç¨‹\"å“ç‰Œçš„å¦‚ä¸‹äº§å“åˆ›ä½œä¸€æ¡ç§‘æ™®çŸ¥è¯†çš„å°çº¢ä¹¦æ–‡æ¡ˆ\n\n{\"product_name\": \"å‡€é¢œç„•é‡‡ç²¾å\", \"category\": \"ç²¾å\", \"core_ingredients\": \"10%çƒŸé…°èƒº, é”ŒPCA, çº¢æ²¡è¯é†‡\", \"features\": \"é«˜æµ“åº¦çƒŸé…°èƒº, æºå¤´æ§æ²¹, æ”¹å–„æš—æ²‰\", \"target_audience\": \"æ²¹æ€§ç—˜ç—˜è‚Œ\"}",
            "chosen": "ğŸ” æŠ¤è‚¤å°è¯¾å ‚ï¼šä¸ºä»€ä¹ˆä½ æ§æ²¹ç¥›ç—˜æ€»æ˜¯å¤±è´¥ï¼Ÿ\n\næ²¹çš®çš„æœ‹å‹ä»¬ï¼Œæ˜¯ä¸æ˜¯æ€»è§‰å¾—è„¸è¶Šæ§è¶Šæ²¹ï¼Œç—˜ç—˜æ­¤èµ·å½¼ä¼ï¼Ÿä»Šå¤©æˆ‘ä»¬æ¥èŠèŠæŠ¤è‚¤ç•Œå…¬è®¤çš„'æ²¹ç—˜è‚Œæ•‘æ˜Ÿ'â€”â€”çƒŸé…°èƒºã€‚\n\nğŸ’¡ çƒŸé…°èƒºæ˜¯ä»€ä¹ˆï¼Ÿ\nå®ƒæ˜¯ç»´ç”Ÿç´ B3çš„è¡ç”Ÿç‰©ï¼Œä¸´åºŠå®è¯èƒ½ï¼š\n1ï¸âƒ£ æŠ‘åˆ¶çš®è„‚è…ºè¿‡åº¦æ´»è·ƒï¼ˆæºå¤´æ§æ²¹ï¼‰\n2ï¸âƒ£ å‡å°‘æ²¹è„‚æ°§åŒ–å¯¼è‡´çš„æš—æ²‰ï¼ˆæäº®è‚¤è‰²ï¼‰\n3ï¸âƒ£ å¢å¼ºçš®è‚¤å±éšœåŠŸèƒ½ï¼ˆå‡å°‘åå¤é•¿ç—˜ï¼‰\n\nâš ï¸ ä½†è¦æ³¨æ„ï¼š\nâ€¢ æµ“åº¦ï¼œ5%æ•ˆæœå¾®å¼±\nâ€¢ éœ€æ­é…é”Œç±»æˆåˆ†ååŒæ§æ²¹\nâ€¢ æ•æ„Ÿè‚Œå»ºè®®ä»2%å¼€å§‹å»ºç«‹è€å—\n\nâœ¨ ç§‘å­¦å®è·µæ¡ˆä¾‹ï¼šåŸç´ æ–¹ç¨‹ã€Œå‡€é¢œç„•é‡‡ç²¾åã€\né…æ–¹äº®ç‚¹ï¼š\nâ–«ï¸10%é»„é‡‘æµ“åº¦çƒŸé…°èƒºï¼ˆç»çš®å¸æ”¶æœ€ä½³åŒºé—´ï¼‰\nâ–«ï¸é”ŒPCAç²¾å‡†å¸é™„å¤šä½™æ²¹è„‚\nâ–«ï¸çº¢æ²¡è¯é†‡èˆ’ç¼“æ§æ²¹åçš„æ³›çº¢\n\næ²¡æœ‰é…’ç²¾/é¦™ç²¾çš„åˆºæ¿€é…æ–¹ï¼Œç”¨ç²¾ç®€çš„6ç§æœ‰æ•ˆæˆåˆ†ï¼Œå®ç°æ§æ²¹+è¤ªçº¢+æäº®ä¸‰é‡ç›®æ ‡ã€‚\n\nğŸ“š çŸ¥è¯†ç‚¹æ€»ç»“ï¼š\næ§æ²¹ä¸æ˜¯ä¸€å‘³å»è§’è´¨ï¼Œè€Œæ˜¯é€šè¿‡è°ƒèŠ‚çš®è„‚è…ºåŠŸèƒ½ï¼ˆçƒŸé…°èƒºï¼‰+ç‰©ç†å¸é™„ï¼ˆé”Œï¼‰+æŠ—ç‚ï¼ˆçº¢æ²¡è¯é†‡ï¼‰çš„ç§‘å­¦ç»„åˆæ‹³ã€‚\n\n#æŠ¤è‚¤ç§‘æ™® #æ²¹çš®æŠ¤è‚¤ #æˆåˆ†å…š #ç§‘å­¦æŠ¤è‚¤ #åŸç´ æ–¹ç¨‹",
            "rejected": "å‡€é¢œç„•é‡‡ç²¾åæ˜¯ä¸€æ¬¾é’ˆå¯¹æ²¹æ€§ç—˜ç—˜è‚Œè®¾è®¡çš„ç²¾åäº§å“ï¼Œå…¶æ ¸å¿ƒæˆåˆ†åŒ…æ‹¬10%çƒŸé…°èƒºã€é”ŒPCAå’Œçº¢æ²¡è¯é†‡ã€‚å…¶ä¸­ï¼Œ10%çƒŸé…°èƒºä½œä¸ºé«˜æµ“åº¦æˆåˆ†ï¼Œèƒ½å¤Ÿæœ‰æ•ˆæ§åˆ¶çš®è„‚åˆ†æ³Œï¼Œä»æ ¹æœ¬ä¸Šå‡å°‘ç—˜ç—˜çš„äº§ç”Ÿï¼ŒåŒæ—¶æ”¹å–„è‚Œè‚¤æš—æ²‰ï¼Œä½¿è‚¤è‰²æ›´åŠ å‡åŒ€æ˜äº®ã€‚é”ŒPCAåˆ™æœ‰åŠ©äºè°ƒèŠ‚çš®è‚¤æ²¹è„‚å¹³è¡¡ï¼Œçº¢æ²¡è¯é†‡å…·æœ‰è‰¯å¥½çš„èˆ’ç¼“å’ŒæŠ—ç‚ä½œç”¨ï¼Œèƒ½å¤Ÿç¼“è§£ç—˜ç—˜å¼•å‘çš„çº¢è‚¿é—®é¢˜ã€‚è¿™æ¬¾äº§å“ä¸“ä¸ºè¿½æ±‚æ¸…çˆ½è‚¤æ„Ÿå’Œæ”¹å–„è‚Œè‚¤çŠ¶æ€çš„æ²¹æ€§è‚Œè‚¤ç”¨æˆ·è®¾è®¡ã€‚"
        },
        {
            "name": "ç ´é™¤è¯¯åŒºç±»æ–‡æ¡ˆ - ç†æ€§åˆ†æ vs æ¨¡ç³Šè¡¨è¿°",
            "prompt": "è¯·ä¸º\"åŸç´ æ–¹ç¨‹\"å“ç‰Œçš„å¦‚ä¸‹äº§å“åˆ›ä½œä¸€æ¡ç ´é™¤æŠ¤è‚¤è¯¯åŒºçš„å°çº¢ä¹¦æ–‡æ¡ˆ\n\n{\"product_name\": \"å‡€é¢œç„•é‡‡ç²¾å\", \"category\": \"ç²¾å\", \"core_ingredients\": \"10%çƒŸé…°èƒº, é”ŒPCA, çº¢æ²¡è¯é†‡\", \"features\": \"é«˜æµ“åº¦çƒŸé…°èƒº, æºå¤´æ§æ²¹, æ”¹å–„æš—æ²‰\", \"target_audience\": \"æ²¹æ€§ç—˜ç—˜è‚Œ\"}",
            "chosen": "10%çƒŸé…°èƒºå°±æ˜¯çƒ‚è„¸å¯†ç ï¼Ÿé«˜æµ“åº¦â‰ é«˜åŠŸæ•ˆçš„æ®‹é…·çœŸç›¸\n\næŠ¤è‚¤åœˆå¯¹'é«˜æµ“åº¦'çš„ç›²ç›®å´‡æ‹œè¯¥åœåœäº†ã€‚\n\nçœ‹åˆ°10%çƒŸé…°èƒºå°±æ— è„‘å†²ï¼Ÿå…ˆå›ç­”ä¸‰ä¸ªé—®é¢˜ï¼š\n1. ä½ çš„å±éšœèƒ½æ‰¿å—è¿™ä¸ªæµ“åº¦å—ï¼Ÿ\n2. é…æ–¹æ˜¯å¦æœ‰ç¼“å†²ä½“ç³»ï¼Ÿ\n3. å…¶ä»–æˆåˆ†æ˜¯ååŒè¿˜æ˜¯æ‹–åè…¿ï¼Ÿ\n\nç§‘å­¦äº‹å®ï¼š\nâ—¾ï¸ 5%çƒŸé…°èƒºå·²èƒ½å®ç°80%æ§æ²¹æ•ˆæœ\nâ—¾ï¸ è¶…è¿‡8%æµ“åº¦æ—¶åˆºæ¿€æ€§å‘ˆæŒ‡æ•°çº§ä¸Šå‡\nâ—¾ï¸ é”ŒPCAçš„æ§æ²¹ååŒä½œç”¨æ¯”å•çº¯å †æµ“åº¦æ›´é‡è¦\n\nåŸç´ æ–¹ç¨‹å‡€é¢œç„•é‡‡ç²¾åçš„è§£é¢˜æ€è·¯ï¼š\nâœ”ï¸ 10%çƒŸé…°èƒº+é”ŒPCAå½¢æˆæ§æ²¹é—­ç¯\nâœ”ï¸ çº¢æ²¡è¯é†‡å³æ—¶ä¸­å’Œåˆºæ¿€æ€§\nâœ”ï¸ å‰”é™¤æ‰€æœ‰ç€è‰²å‰‚/é…’ç²¾ç­‰åˆºæ¿€æº\n\næ²¹ç—˜è‚Œçš„æ§æ²¹æ–¹æ¡ˆåº”è¯¥åƒç²¾å‡†åŒ–ç–—ï¼šåœ¨æ¸…é™¤ç—…ç¶ï¼ˆè¿‡é‡çš®è„‚ï¼‰çš„åŒæ—¶ï¼Œæœ€å¤§é™åº¦ä¿æŠ¤å¥åº·ç»„ç»‡ï¼ˆå±éšœï¼‰ã€‚é‚£äº›è®©ä½ 'ç—›å°±å¯¹äº†'çš„äº§å“ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯é…æ–¹ä¸åŠæ ¼ã€‚\n\n#ç§‘å­¦æŠ¤è‚¤ #æ²¹çš®è‡ªæ•‘ #æŠ¤è‚¤çœŸç›¸å¤§æ­ç§˜ ä½ è¢«é«˜æµ“åº¦äº§å“å‘è¿‡å—ï¼Ÿ",
            "rejected": "æ˜¯ä¸æ˜¯é«˜æµ“åº¦å°±æ˜¯é«˜æ•ˆï¼Ÿå¹¶éå¦‚æ­¤ï¼Œé«˜æµ“åº¦çš„æˆåˆ†å¦‚æœä½¿ç”¨ä¸å½“ï¼Œåè€Œå¯èƒ½åŠ é‡çš®è‚¤è´Ÿæ‹…ã€‚ä¾‹å¦‚ï¼Œè¿‡é«˜çš„çƒŸé…°èƒºæµ“åº¦ä¼šå¯¼è‡´çš®è‚¤æ•æ„Ÿï¼Œæ— æ³•é•¿æœŸä¿æŒè‚Œè‚¤å¥åº·ã€‚è€ŒåŸç´ æ–¹ç¨‹å‡€é¢œç„•é‡‡ç²¾ååˆ™é‡‡ç”¨äº†ç§‘å­¦é…æ¯”ï¼Œå…¶ä¸­10%çš„çƒŸé…°èƒºæµ“åº¦æ—¢èƒ½æœ‰æ•ˆæ§åˆ¶æ²¹è„‚åˆ†æ³Œã€æ”¹å–„æš—æ²‰ï¼Œåˆä¸ä¼šå¯¼è‡´çš®è‚¤åˆºæ¿€ï¼Œé”ŒPCAå’Œçº¢æ²¡è¯é†‡çš„åŠ å…¥æ›´æ˜¯ä¸ºè‚Œè‚¤æä¾›äº†é¢å¤–çš„èˆ’ç¼“ä¸ä¿®å¤ã€‚"
        },
        {
            "name": "ä¸ªäººæ•…äº‹ç±»æ–‡æ¡ˆ - çœŸå®ä½“éªŒ vs ç©ºæ´æè¿°",
            "prompt": "è¯·ä¸º\"åŸç´ æ–¹ç¨‹\"å“ç‰Œçš„å¦‚ä¸‹äº§å“åˆ›ä½œä¸€æ¡ä¸ªäººä½¿ç”¨æ•…äº‹çš„å°çº¢ä¹¦æ–‡æ¡ˆ\n\n{\"product_name\": \"å‡€é¢œç„•é‡‡ç²¾å\", \"category\": \"ç²¾å\", \"core_ingredients\": \"10%çƒŸé…°èƒº, é”ŒPCA, çº¢æ²¡è¯é†‡\", \"features\": \"é«˜æµ“åº¦çƒŸé…°èƒº, æºå¤´æ§æ²¹, æ”¹å–„æš—æ²‰\", \"target_audience\": \"æ²¹æ€§ç—˜ç—˜è‚Œ\"}",
            "chosen": "æœ€è¿‘å·¥ä½œå‹åŠ›å¤§ï¼Œçš®è‚¤çŠ¶æ€ä¹Ÿè·Ÿç€é­æ®ƒã€‚ä½œä¸ºä¸€ä¸ªæ²¹ç—˜è‚Œï¼Œé¢å¤´å’Œä¸‹å·´çš„é—­å£æ­¤èµ·å½¼ä¼ï¼ŒTåŒºæ²¹å…‰é—ªäº®åˆ°èƒ½å½“é•œå­ç…§ã€‚ğŸ˜­\n\né‚£å¤©ä¸‹ç­åå’Œé—ºèœœçº¦é¥­ï¼Œå¥¹ç›¯ç€æˆ‘çš„è„¸çªç„¶è¯´ï¼š\"ä½ çš„çš®è‚¤æ€ä¹ˆè¿™ä¹ˆæš—æ²‰ï¼Ÿ\" é•œå­é‡Œçš„è‡ªå·±ç¡®å®åƒè’™äº†ä¸€å±‚ç°ã€‚å›å®¶åï¼Œæˆ‘å†³å®šè®¤çœŸå¯¹å¾…è¿™ä¸ªé—®é¢˜ã€‚\n\nåœ¨åšäº†å¾ˆå¤šåŠŸè¯¾ä¹‹åï¼Œæˆ‘é€‰æ‹©äº†åŸç´ æ–¹ç¨‹çš„å‡€é¢œç„•é‡‡ç²¾åã€‚å¸å¼•æˆ‘çš„æ˜¯å®ƒç²¾ç®€æœ‰æ•ˆçš„é…æ–¹ï¼š10%çƒŸé…°èƒºæµ“åº¦åˆšåˆšå¥½ï¼Œé”ŒPCAèƒ½æºå¤´æ§æ²¹ï¼Œçº¢æ²¡è¯é†‡æ¸©å’Œä¿®æŠ¤ã€‚æ²¡æœ‰èŠ±å“¨çš„åŒ…è£…ï¼Œç™½è‰²ç“¶èº«ä¸Šç®€å•çš„æ ‡ç­¾é€ç€ç§‘ç ”æ„Ÿçš„ä¸¥è°¨ã€‚\n\nè¿ç»­ä½¿ç”¨ä¸¤å‘¨åï¼Œæœ€æ˜æ˜¾çš„å˜åŒ–æ˜¯æ—©ä¸Šé†’æ¥æ—¶ï¼Œè„¸ä¸Šä¸å†æ³›ç€æ²¹å…‰ã€‚ä»¥å‰æ¯åˆ°ä¸‹åˆå°±å¿…é¡»ç”¨å¸æ²¹çº¸ï¼Œç°åœ¨è¿™ç§éœ€æ±‚å°‘äº†å¾ˆå¤šã€‚æ›´è®©æˆ‘æƒŠå–œçš„æ˜¯ï¼Œé‚£äº›é¡½å›ºçš„é—­å£æ…¢æ…¢å¹³å¤äº†ï¼Œè„¸é¢Šçš„æ¯›å­”çœ‹èµ·æ¥ä¹Ÿå¹²å‡€äº†è®¸å¤šã€‚\n\nç°åœ¨æ¯å¤©æŠ¤è‚¤æ—¶ï¼Œæ»´ä¸¤æ»´ç²¾ååœ¨æŒå¿ƒï¼Œè½»è½»æŒ‰å‹ä¸Šè„¸çš„é‚£ä¸€åˆ»ï¼Œåƒæ˜¯åœ¨ç»™çš®è‚¤åšä¸€ä¸ªç®€å•è€Œæœ‰æ•ˆçš„ç§‘å­¦æŠ¤ç†ã€‚å®ƒæ²¡æœ‰ç«‹ç«¿è§å½±çš„\"å¥‡è¿¹\"ï¼Œä½†æ­£æ˜¯è¿™ç§æ¸©å’Œè€ŒæŒç»­çš„æ”¹å–„ï¼Œè®©æˆ‘é‡æ–°æ‰¾å›äº†è‚Œè‚¤çš„å¹³è¡¡çŠ¶æ€ã€‚\n\næœ‰æ—¶å€™ï¼Œè§£å†³é—®é¢˜ä¸éœ€è¦å¤æ‚çš„æ­¥éª¤ï¼Œæ‰¾åˆ°å¯¹çš„é…æ–¹ï¼Œç»™çš®è‚¤æœ€éœ€è¦çš„ï¼Œå°±å¤Ÿäº†ã€‚\n\n#æ²¹ç—˜è‚ŒæŠ¤ç† #ç²¾ç®€æŠ¤è‚¤ #ç§‘å­¦é…æ–¹ #æ§æ²¹ç²¾å",
            "rejected": "æˆ‘åŸæ¥é¢éƒ¨ç»å¸¸çº¢è‚¿ï¼Œæ²¹è„‚åˆ†æ³Œæ—ºç››ï¼Œè‚¤è‰²ä¹Ÿä¸å¤Ÿæ˜äº®ã€‚è‡ªä»ç”¨äº†å‡€é¢œç„•é‡‡ç²¾ååï¼Œè¿™æ¬¾äº§å“å«æœ‰10%çƒŸé…°èƒºï¼Œèƒ½å¤Ÿæœ‰æ•ˆæ§åˆ¶æ²¹è„‚åˆ†æ³Œï¼ŒåŒæ—¶è¿˜åŠ å…¥äº†é”ŒPCAå’Œçº¢æ²¡è¯é†‡ï¼Œå¸®åŠ©èˆ’ç¼“è‚Œè‚¤ï¼Œå‡å°‘çº¢è‚¿ã€‚ç°åœ¨æˆ‘çš„è‚Œè‚¤çŠ¶æ€å¥½äº†å¾ˆå¤šï¼Œè‚¤è‰²ä¹Ÿæ›´åŠ å‡åŒ€é€äº®äº†ã€‚"
        },
        {
            "name": "ç”µå•†ä»‹ç»ç±»æ–‡æ¡ˆ - ä¸“ä¸šè¯¦ç»† vs ç®€å•ç½—åˆ—",
            "prompt": "è¯·ä¸º\"åŸç´ æ–¹ç¨‹\"å“ç‰Œçš„å¦‚ä¸‹äº§å“åˆ›ä½œä¸€æ¡è¯¦ç»†çš„ç”µå•†å¹³å°äº§å“ä»‹ç»æ–‡æ¡ˆ\n\n{\"product_name\": \"å‡€é¢œç„•é‡‡ç²¾å\", \"category\": \"ç²¾å\", \"core_ingredients\": \"10%çƒŸé…°èƒº, é”ŒPCA, çº¢æ²¡è¯é†‡\", \"features\": \"é«˜æµ“åº¦çƒŸé…°èƒº, æºå¤´æ§æ²¹, æ”¹å–„æš—æ²‰\", \"target_audience\": \"æ²¹æ€§ç—˜ç—˜è‚Œ\"}",
            "chosen": "ã€åŸç´ æ–¹ç¨‹ | å‡€é¢œç„•é‡‡ç²¾åã€‘ç§‘å­¦é…æ–¹ï¼Œç²¾å‡†è§£å†³æ²¹ç—˜è‚Œå›°æ‰°\n\næ²¹æ€§ç—˜ç—˜è‚Œçš„å›°æ‰°ï¼Œæºäºçš®è„‚è¿‡åº¦åˆ†æ³Œä¸å±éšœåŠŸèƒ½å¤±è¡¡ã€‚åŸç´ æ–¹ç¨‹ç ”å‘å›¢é˜Ÿä»ç§‘å­¦è§’åº¦å‡ºå‘ï¼Œé’ˆå¯¹è¿™ä¸€è‚Œè‚¤é—®é¢˜ï¼Œè®¾è®¡äº†è¿™æ¬¾ã€Œå‡€é¢œç„•é‡‡ç²¾åã€ã€‚æˆ‘ä»¬æ‘’å¼ƒå¤æ‚æˆåˆ†å †ç Œï¼Œä»¥ç²¾ç®€æœ‰æ•ˆçš„é…æ–¹ï¼Œä»æºå¤´æ”¹å–„è‚Œè‚¤çŠ¶æ€ã€‚\n\nç§‘å­¦é…æ–¹è§£æ\n1. 10%æµ“åº¦çƒŸé…°èƒºï¼šç»ä¸´åºŠéªŒè¯çš„æœ‰æ•ˆæµ“åº¦ï¼Œèƒ½æ˜¾è‘—æŠ‘åˆ¶çš®è„‚è…ºæ´»è·ƒåº¦ï¼Œä»æºå¤´å‡å°‘æ²¹è„‚åˆ†æ³Œã€‚åŒæ—¶ä¿ƒè¿›è§’è´¨ä»£è°¢ï¼Œæ”¹å–„æ¯›å­”å µå¡é—®é¢˜ã€‚\n2. é”ŒPCAï¼šå…·æœ‰å‡ºè‰²çš„æ§æ²¹ä¸æŠ‘èŒåŠŸæ•ˆï¼ŒååŒçƒŸé…°èƒºè°ƒèŠ‚çš®è„‚è†œå¥åº·çŠ¶æ€ã€‚\n3. çº¢æ²¡è¯é†‡ï¼šæ¸©å’Œèˆ’ç¼“æˆåˆ†ï¼Œç¼“è§£å› ç—˜ç—˜å¼•å‘çš„è‚Œè‚¤ä¸é€‚ï¼Œä¿®æŠ¤å—æŸå±éšœã€‚\n\näº§å“ä½œç”¨æœºç†\nè¿™æ¬¾ç²¾åé€šè¿‡é¶å‘è°ƒèŠ‚çš®è„‚è…ºåŠŸèƒ½ï¼Œå®ç°é•¿æ•ˆæ§æ²¹ï¼›åŒæ—¶ä¼˜åŒ–è‚Œè‚¤å¾®ç¯å¢ƒï¼Œå‡å°‘ç—˜ç—˜åå¤å‘ç”Ÿã€‚çƒŸé…°èƒºçš„åŠ å…¥è¿˜èƒ½é˜»æ–­é»‘è‰²ç´ è½¬è¿ï¼Œé€æ­¥æ”¹å–„å› å‡ºæ²¹æ°§åŒ–å¯¼è‡´çš„è‚¤è‰²æš—æ²‰é—®é¢˜ã€‚\n\nä½¿ç”¨å»ºè®®\nå»ºè®®æ¯æ—¥æ—©æ™šæ´é¢åä½¿ç”¨ï¼Œé…åˆè½»æŸ”æŒ‰æ‘©ä¿ƒè¿›å¸æ”¶ã€‚é…æ–¹ç»è¿‡ä¸¥æ ¼æµ‹è¯•ï¼Œæ¸©å’Œä¸åˆºæ¿€ï¼Œä½†é¦–æ¬¡ä½¿ç”¨é«˜æµ“åº¦çƒŸé…°èƒºäº§å“å»ºè®®å…ˆå»ºç«‹è€å—ã€‚\n\nåŸç´ æ–¹ç¨‹åšæŒç”¨ç§‘å­¦è¯´è¯ï¼Œæ¯ä¸€æ¬¾äº§å“éƒ½ç»è¿‡åå¤éªŒè¯ã€‚å‡€é¢œç„•é‡‡ç²¾åä¸æ‰¿è¯ºç«‹ç«¿è§å½±çš„æ•ˆæœï¼Œä½†åšæŒä½¿ç”¨28å¤©ï¼Œä½ å°†çœ‹åˆ°è‚Œè‚¤çŠ¶æ€çš„æ˜æ˜¾æ”¹å–„ã€‚",
            "rejected": "è¿™æ¬¾äº§å“æ˜¯å‡€é¢œç„•é‡‡ç²¾åï¼Œå±äºç²¾åç±»äº§å“ã€‚å…¶æ ¸å¿ƒæˆåˆ†åŒ…æ‹¬10%çƒŸé…°èƒºã€é”ŒPCAå’Œçº¢æ²¡è¯é†‡ã€‚è¿™æ¬¾ç²¾åé€šè¿‡é«˜æµ“åº¦çƒŸé…°èƒºæœ‰æ•ˆæ§åˆ¶æ²¹è„‚åˆ†æ³Œï¼Œä»æºå¤´æ”¹å–„è‚Œè‚¤æš—æ²‰é—®é¢˜ï¼Œç‰¹åˆ«é€‚åˆæ²¹æ€§ç—˜ç—˜è‚Œä½¿ç”¨ã€‚"
        }
    ]
    return test_cases


def load_reward_model(model_path: str):
    """
    åŠ è½½å¥–åŠ±æ¨¡å‹å’Œåˆ†è¯å™¨
    """
    print(f"--- æ­£åœ¨åŠ è½½å¥–åŠ±æ¨¡å‹: {model_path} ---")
    
    try:
        # åŠ è½½åˆ†è¯å™¨å’Œæ¨¡å‹
        tokenizer = AutoTokenizer.from_pretrained(model_path, trust_remote_code=True)
        model = AutoModelForSequenceClassification.from_pretrained(model_path, trust_remote_code=True)
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„ GPU
        device = "cuda" if torch.cuda.is_available() else "cpu"
        model.to(device)
        model.eval()  # è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼
        
        print(f"--- æ¨¡å‹åŠ è½½æˆåŠŸï¼Œè¿è¡Œåœ¨: {device} ---")
        return model, tokenizer, device
        
    except Exception as e:
        print(f"æ¨¡å‹åŠ è½½å¤±è´¥: {e}")
        return None, None, None


def calculate_reward_score(model, tokenizer, device, prompt: str, response: str) -> float:
    """
    è®¡ç®—å•ä¸ªå›ç­”çš„å¥–åŠ±åˆ†æ•°
    """
    # æ„å»ºå¯¹è¯æ¶ˆæ¯
    messages = [
        {"role": "user", "content": prompt},
        {"role": "assistant", "content": response}
    ]
    
    # åº”ç”¨èŠå¤©æ¨¡æ¿å¹¶è½¬æ¢ä¸ºtensor
    try:
        input_text = tokenizer.apply_chat_template(
            messages, 
            add_generation_prompt=False, 
            return_tensors="pt"
        ).to(device)
    except Exception as e:
        # å¦‚æœèŠå¤©æ¨¡æ¿å¤±è´¥ï¼Œä½¿ç”¨ç®€å•æ ¼å¼
        input_text = tokenizer(
            f"ç”¨æˆ·: {prompt}\nåŠ©æ‰‹: {response}",
            return_tensors="pt",
            padding=True,
            truncation=True,
            max_length=1024
        ).to(device)
    
    # æ¨¡å‹æ¨ç†
    with torch.no_grad():
        score = model(input_text).logits[0].item()
    
    return score


def run_single_test(model, tokenizer, device, test_case: Dict[str, Any]) -> Dict[str, Any]:
    """
    è¿è¡Œå•ä¸ªæµ‹è¯•ç”¨ä¾‹
    """
    print(f"\n{'='*60}")
    print(f"æµ‹è¯•ç”¨ä¾‹: {test_case['name']}")
    print(f"{'='*60}")
    
    # è®¡ç®—åˆ†æ•°
    score_chosen = calculate_reward_score(
        model, tokenizer, device, 
        test_case['prompt'], test_case['chosen']
    )
    
    score_rejected = calculate_reward_score(
        model, tokenizer, device, 
        test_case['prompt'], test_case['rejected']
    )
    
    # åˆ¤æ–­ç»“æœ
    is_correct = score_chosen > score_rejected
    score_diff = score_chosen - score_rejected
    
    print(f"å¥½çš„å›ç­”åˆ†æ•°: {score_chosen:.4f}")
    print(f"åçš„å›ç­”åˆ†æ•°: {score_rejected:.4f}")
    print(f"åˆ†æ•°å·®å¼‚: {score_diff:.4f}")
    print(f"åˆ¤æ–­ç»“æœ: {'âœ… æ­£ç¡®' if is_correct else 'âŒ é”™è¯¯'}")
    
    return {
        "test_name": test_case['name'],
        "score_chosen": score_chosen,
        "score_rejected": score_rejected,
        "score_diff": score_diff,
        "is_correct": is_correct
    }


def evaluate_model_on_dataset(model, tokenizer, device, dataset: List[Dict[str, Any]], model_name: str):
    """
    åœ¨éªŒè¯é›†ä¸Šè¯„ä¼°æ¨¡å‹
    
    Args:
        model: å¥–åŠ±æ¨¡å‹
        tokenizer: åˆ†è¯å™¨
        device: è®¾å¤‡
        dataset: éªŒè¯æ•°æ®é›†
        model_name: æ¨¡å‹åç§°
        
    Returns:
        è¯„ä¼°ç»“æœå­—å…¸
    """
    print(f"\n--- å¼€å§‹è¯„ä¼° {model_name} ---")
    
    chosen_scores = []
    rejected_scores = []
    
    for i, item in enumerate(dataset):
        prompt = item['prompt']
        chosen = item['chosen']
        rejected = item['rejected']
        
        # è®¡ç®—chosençš„åˆ†æ•°
        chosen_score = calculate_reward_score(model, tokenizer, device, prompt, chosen)
        chosen_scores.append(chosen_score)
        
        # è®¡ç®—rejectedçš„åˆ†æ•°
        rejected_score = calculate_reward_score(model, tokenizer, device, prompt, rejected)
        rejected_scores.append(rejected_score)
        
        if (i + 1) % 50 == 0:
            print(f"å·²å¤„ç† {i + 1}/{len(dataset)} æ¡æ•°æ®")
    
    # è®¡ç®—å¹³å‡å€¼
    avg_chosen_score = sum(chosen_scores) / len(chosen_scores)
    avg_rejected_score = sum(rejected_scores) / len(rejected_scores)
    score_diff = avg_chosen_score - avg_rejected_score
    
    print(f"{model_name} è¯„ä¼°å®Œæˆ:")
    print(f"  æ­£æ ·æœ¬å¹³å‡åˆ†æ•°: {avg_chosen_score:.4f}")
    print(f"  è´Ÿæ ·æœ¬å¹³å‡åˆ†æ•°: {avg_rejected_score:.4f}")
    print(f"  åˆ†æ•°å·®å¼‚: {score_diff:.4f}")
    
    return {
        "model_name": model_name,
        "avg_chosen_score": avg_chosen_score,
        "avg_rejected_score": avg_rejected_score,
        "score_diff": score_diff,
        "chosen_scores": chosen_scores,
        "rejected_scores": rejected_scores
    }


def run_reward_model_tests():
    """
    è¿è¡Œå®Œæ•´çš„å¥–åŠ±æ¨¡å‹æµ‹è¯•
    """
    print("=== å¥–åŠ±æ¨¡å‹å¯¹æ¯”æµ‹è¯•å¼€å§‹ ===")
    
    # é…ç½®è·¯å¾„
    base_model_path = "models/Skywork-Reward-V2-Qwen3-0.6B"  # åŸºç¡€æ¨¡å‹è·¯å¾„
    finetuned_model_path = "models/Skywork-Reward-V2-Qwen3-0.6B-finetuned"  # å¾®è°ƒåæ¨¡å‹è·¯å¾„
    val_dataset_path = "data/val_dataset_final.jsonl"  # éªŒè¯æ•°æ®é›†è·¯å¾„
    
    # åŠ è½½éªŒè¯æ•°æ®é›†
    print("æ­£åœ¨åŠ è½½éªŒè¯æ•°æ®é›†...")
    val_dataset = load_val_dataset(val_dataset_path)
    print(f"æˆåŠŸåŠ è½½éªŒè¯æ•°æ®é›†: {len(val_dataset)} æ¡")
    
    # åŠ è½½åŸºç¡€æ¨¡å‹
    print("\næ­£åœ¨åŠ è½½åŸºç¡€æ¨¡å‹...")
    base_model, base_tokenizer, device = load_reward_model(base_model_path)
    if base_model is None:
        print("åŸºç¡€æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œæµ‹è¯•ç»ˆæ­¢")
        return
    
    # åŠ è½½å¾®è°ƒåæ¨¡å‹
    print("\næ­£åœ¨åŠ è½½å¾®è°ƒåæ¨¡å‹...")
    finetuned_model, finetuned_tokenizer, device = load_reward_model(finetuned_model_path)
    if finetuned_model is None:
        print("å¾®è°ƒåæ¨¡å‹åŠ è½½å¤±è´¥ï¼Œæµ‹è¯•ç»ˆæ­¢")
        return
    
    # åœ¨éªŒè¯é›†ä¸Šè¯„ä¼°åŸºç¡€æ¨¡å‹
    base_results = evaluate_model_on_dataset(base_model, base_tokenizer, device, val_dataset, "åŸºç¡€æ¨¡å‹")
    
    # åœ¨éªŒè¯é›†ä¸Šè¯„ä¼°å¾®è°ƒåæ¨¡å‹
    finetuned_results = evaluate_model_on_dataset(finetuned_model, finetuned_tokenizer, device, val_dataset, "å¾®è°ƒåæ¨¡å‹")
    
    # å¯¹æ¯”ç»“æœ
    print(f"\n{'='*60}")
    print("æ¨¡å‹å¯¹æ¯”ç»“æœ")
    print(f"{'='*60}")
    print(f"æ•°æ®é›†å¤§å°: {len(val_dataset)} æ¡")
    print()
    print("åŸºç¡€æ¨¡å‹:")
    print(f"  æ­£æ ·æœ¬å¹³å‡åˆ†æ•°: {base_results['avg_chosen_score']:.4f}")
    print(f"  è´Ÿæ ·æœ¬å¹³å‡åˆ†æ•°: {base_results['avg_rejected_score']:.4f}")
    print(f"  åˆ†æ•°å·®å¼‚: {base_results['score_diff']:.4f}")
    print()
    print("å¾®è°ƒåæ¨¡å‹:")
    print(f"  æ­£æ ·æœ¬å¹³å‡åˆ†æ•°: {finetuned_results['avg_chosen_score']:.4f}")
    print(f"  è´Ÿæ ·æœ¬å¹³å‡åˆ†æ•°: {finetuned_results['avg_rejected_score']:.4f}")
    print(f"  åˆ†æ•°å·®å¼‚: {finetuned_results['score_diff']:.4f}")
    print()
    print("æ”¹è¿›æƒ…å†µ:")
    chosen_improvement = finetuned_results['avg_chosen_score'] - base_results['avg_chosen_score']
    rejected_improvement = finetuned_results['avg_rejected_score'] - base_results['avg_rejected_score']
    diff_improvement = finetuned_results['score_diff'] - base_results['score_diff']
    
    print(f"  æ­£æ ·æœ¬åˆ†æ•°å˜åŒ–: {chosen_improvement:+.4f}")
    print(f"  è´Ÿæ ·æœ¬åˆ†æ•°å˜åŒ–: {rejected_improvement:+.4f}")
    print(f"  åˆ†æ•°å·®å¼‚å˜åŒ–: {diff_improvement:+.4f}")
    
    if diff_improvement > 0:
        print(f"  âœ… å¾®è°ƒåæ¨¡å‹è¡¨ç°æ›´å¥½ï¼Œåˆ†æ•°å·®å¼‚å¢åŠ äº† {diff_improvement:.4f}")
    else:
        print(f"  âŒ å¾®è°ƒåæ¨¡å‹è¡¨ç°è¾ƒå·®ï¼Œåˆ†æ•°å·®å¼‚å‡å°‘äº† {abs(diff_improvement):.4f}")
    
    print("=== å¥–åŠ±æ¨¡å‹å¯¹æ¯”æµ‹è¯•å®Œæˆ ===")


if __name__ == "__main__":
    try:
        run_reward_model_tests()
    except Exception as e:
        print(f"æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
